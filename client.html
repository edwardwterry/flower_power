<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ROS2 A-Frame Example</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
</head>

<body>
    <a-scene>
        <a-ocean color="#00aabb" width="50" depth="50" density="20"></a-ocean>
        <a-entity id="ego">
            <a-camera id="camera"></a-camera>
          </a-entity>
        <!-- <a-camera id="ego" position="0 0 0" rotation="0 0 0" look-controls></a-camera> -->
        <a-sky color="#ECECEC"></a-sky>

        <a-assets>
            <a-asset-item id="myModel"
                src="https://edwardwterry.github.io/flower_power/assets/scene.gltf"></a-asset-item>
        </a-assets>

        <!-- Entities -->
        <a-entity id="target" gltf-model="#myModel" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>

    </a-scene>

    <!-- Place this script at the end of the body tag -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = new WebSocket('ws://localhost:9090');

            socket.addEventListener('open', function () {
                console.log('Connected to ROSBridge WebSocket!');

                let subscribe_msg = {
                    op: 'subscribe',
                    topic: '/target/pose',
                    type: 'geometry_msgs/msg/PoseStamped'
                };
                socket.send(JSON.stringify(subscribe_msg));

                subscribe_msg = {
                    op: 'subscribe',
                    topic: '/ego/pose',
                    type: 'geometry_msgs/msg/PoseStamped'
                };
                socket.send(JSON.stringify(subscribe_msg));
            });

            socket.addEventListener('message', function (event) {
                let msg = JSON.parse(event.data);
                let position = msg.msg.pose.position;
                let quaternion = msg.msg.pose.orientation;

                let object3D = new THREE.Object3D(); // Three.js object
                object3D.quaternion.set(quaternion.x, quaternion.y, quaternion.z, quaternion.w);

                // Convert quaternion to Euler angles
                let euler = new THREE.Euler();
                euler.setFromQuaternion(object3D.quaternion, 'YXZ');

                // Convert radians to degrees
                let rotation = {
                    x: THREE.MathUtils.radToDeg(euler.x),
                    y: THREE.MathUtils.radToDeg(euler.y),
                    z: THREE.MathUtils.radToDeg(euler.z)
                };

                updateCubePose(position, rotation, msg.msg.header.frame_id);
            });

        });

        function updateCubePose(position, orientation, entity) {
            let cube = document.querySelector('#' + entity);
            cube.setAttribute('position', { x: position.y, y: position.z, z: position.x }); // TODO reorient?
            cube.setAttribute('rotation', { x: orientation.x, y: orientation.z, z: orientation.y });
            if (entity == 'ego') {
                console.log(cube.getAttribute('rotation'))
            }
        }

    </script>
</body>

</html>